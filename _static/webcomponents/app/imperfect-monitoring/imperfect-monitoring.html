<link
	rel="import"
	href="/static/bower_components/polymer/polymer.html" />
<link
    rel="import"
    href="/static/otree-redwood/webcomponents/otree-channel/otree-channel.html">
<link
    rel="import"
    href="/static/otree-redwood/webcomponents/otree-continuous-decision/otree-continuous-decision.html">
<link
    rel="import"
    href="/static/otree-redwood/webcomponents/otree-period/otree-period.html">

    
<dom-module id="imperfect-monitoring">

	<template>

		<link rel="stylesheet" href="styles.css">
        <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
        <script src="/static/bootstrap/js/bootstrap.min.js"></script>
	
        <otree-period></otree-period>
        <otree-continuous-decision
            component="imperfect-monitoring"
            my-decision="{{ myDecision }}">
        </otree-continuous-decision>
        <otree-channel
            channel="tick"
            on-event="_onTick">
        </otree-channel>

        <div id="experimentContainer">
            <progress
                id="myProgress"
                value="[[ pauseProgress ]]"
                hidden$="[[ hideProgress ]]">
            </progress>

            <div class="graph-container">
                <div id="currSubperiodGraph"></div>
                <div id="historyGraph"></div>
            </div>

            <div id="myDecisionContainer">
                <!--
                buttons for choosing strategy.
                -->
                <button
                    id="buttonA" 
    				name="decision"
    				on-tap="_setMyDecision"
    				value=1
                    type="button"
                    data-toggle="button"
    				class$="btn btn-success btn-large [[ _buttonActive(myDecision, 1) ]]">
    				Contribute
    			</button>
                <button
                    id="buttonB"
    				name="decision"
    				on-tap="_setMyDecision" 
    				value=0
                    type="button"
                    data-toggle="button"
    				class$="btn btn-warning btn-large [[ _buttonActive(myDecision, 0) ]]">
    				Don't Contribute
    			</button>
            </div>    
        </div>
    
	</template>

	<script>
		Polymer({
			is: 'imperfect-monitoring',
			properties: {
				// 2x2 array of payoffs for each player.
                payoffMatrix: Array,
                // 2x2 array of probability based on player's decision.
                probabilityMatrix: Array,
                // index describing which entry in payoff matrix is to be used by this player
                playerIndex: Number,
                // boolean to choose whether or not to play against a human or robot. 0 is for robot, 1 is for human.
                alpha: Number,
                // synced by the otree-continuous-decision component
                myDecision: Number,
                // probablility that game continues in any period-- which... I don't really understand what that means
                delta: Number,
                // deltat in ms
                periodLength: Number,
                // a parameter for controlling the y-axis in basically all the graphs
                axis: Number,
                // numer of periods over which the subject's action is held fixed
                tau: Number,
                // N milliseconds in the pause between every tau-window
                pauseTime: Number,
                // True if the progress bar should be hidden.
                hideProgress: {
                    type: Boolean,
                    value: true,
                },
                aColor: {
                    type: String,
                    value: 'rgba(0, 100, 0, 0.4)'
                },
                bColor: {
                    type: String,
                    value: 'rgba(255, 100, 0, 0.4)'
                }
			},
			ready() {
                // separate each player's payoffs into two separate arrays
                this.myPayoffs = this.payoffMatrix.map(function (current_val) {
                    return parseInt(current_val[this.playerIndex]);
                }, this);
                this.mySignals = this.probabilityMatrix.map(function (current_val) {
                    return parseFloat(current_val[this.playerIndex]);
                }, this);
			},
            attached() {
                this._setupCurrSubperiodGraph();
                this._setupHistoryGraph();
            },
            _onTick(event) {
                let msg = event.detail.payload;
                if (msg.realizedPayoffs) {
                    this._updateCurrSubperiodGraph(msg.realizedPayoffs[oTree.participantCode]);
                }
                if (msg.updateHistory) {
                    this._updateHistoryGraph();
                }
                if (msg.clearGraph) {
                    this._clearGraph();
                }
                if (msg.hasOwnProperty('pauseProgress')) {
                    this.hideProgress = false;
                    this.pauseProgress = msg.pauseProgress;
                }
            },
			_equals(d, decision) {
				return d == decision;
			},
            _setMyDecision(event) {
                event.preventDefault();
                var d = parseFloat(event.target.value);
                this.myDecision = d;
            },
            // sets up current subperiod graph
            _setupCurrSubperiodGraph() {
                // call highcharts setup function
                this.currSubperiodGraph = Highcharts.chart({
                    chart: {
                        animation: false,
                        renderTo: this.$.currSubperiodGraph,
                        enabled: false,
                        width: 300,
                    },
                    title: { text: null },
                    exporting: { enabled: false },
                    tooltip: { enabled: false },
                    legend: { enabled: true },
                    credits: { enabled: false },
                    xAxis: {
                        min: 0,
                        max: 5,
                        tickInterval: 1,
                        labels: { enabled: true }
                    },
                    yAxis: {
                        title: { text: undefined },
                        minPadding: 0.05,
                        maxPadding: 0.05,
                        endOnTick: false,
                        labels: { enabled: true },
                    },
                    plotOptions: {
                        column: {
                        },
                        line: {marker: {enabled: false}},
                        series: {
                            pointPadding: 0,
                            borderWidth: 0,
                            states: {
                                hover: {
                                    enabled: false,
                                }
                            }
                       }
                    },
                    line: {
                        marker: {
                            enabled: false,
                            states: {
                                hover: { enabled: false },
                                select: { enabled: false }
                            }
                        }
                    },
                    series: [
                        {
                            name: "Realized Payoff",
                            type: "column",
                            data: [
                                [0, 100],
                                [1, 50],
                                [2, 75],
                                [3, 0],
                                [4, 100],
                            ],
                            step: "left",
                        },
                           {
                            name: "Average Payoff",
                            type: "line",
                            data: [],
                            step: "left"
                        },
                        {
                            name: "Aa",
                            type: "line",
                            color: this.aColor,
                            lineWidth: 10,
                            data: [
                                [0, this.payoffMatrix[0][oTree.idInGroup]],
                                [5, this.payoffMatrix[0][oTree.idInGroup]]
                            ],
                            step: "left"
                        },
                        {
                            name: "Ab",
                            type: "line",
                            color: this.aColor,
                            lineWidth: 10,
                            data: [
                                [0, this.payoffMatrix[1][oTree.idInGroup]],
                                [5, this.payoffMatrix[1][oTree.idInGroup]]
                            ],
                            step: "left"
                        },
                        {
                            name: "Ba",
                            type: "line",
                            color: this.bColor,
                            lineWidth: 10,
                            data: [
                                [0, this.payoffMatrix[2][oTree.idInGroup]],
                                [5, this.payoffMatrix[2][oTree.idInGroup]]
                            ],
                            step: "left"
                        },
                        {
                            name: "Bb",
                            type: "line",
                            color: this.bColor,
                            lineWidth: 10,
                            data: [
                                [0, this.payoffMatrix[3][oTree.idInGroup]],
                                [5, this.payoffMatrix[3][oTree.idInGroup]]
                            ],
                            step: "left"
                        },
                    ]
                });
            },
            _setupHistoryGraph() {
                // call highcharts setup function
                this.historyGraph = Highcharts.chart({
                    chart: {
                        animation: false,
                        renderTo: this.$.historyGraph,
                        enabled: false,
                        reflow: false,
                        width: 800,
                    },
                    title: { text: null },
                    exporting: { enabled: false },
                    tooltip: { enabled: false },
                    legend: { enabled: true},
                    credits: { enabled: false },
                    xAxis: {
                        min: 0,
                        max: (10*12)-1,
                        tickInterval: 5,
                        labels: { enabled: true },
                        scrollbar: { enabled: true },
                        plotLines: [{
                            value: 0,
                            width: 0,
                            color: 'lightgrey',
                            reversed: true
                        }]
                    },
                    yAxis: {
                        title: { text: undefined },
                        min: 0,
                        max: this.myPayoffs[2]*1.05,
                        minPadding: 0.05,
                        maxPadding: 0.05,
                        endOnTick: false,
                        labels: { enabled: true },
                    },
                    plotOptions: {
                        column: {
                        },
                        line: {marker: {enabled: false}},
                        series: {
                            borderWidth: 0,
                            pointPadding: 0,
                            states: {
                                hover: {
                                    enabled: false,
                                }
                            }
                       }
                    },
                    line: {
                        marker: {
                            enabled: false,
                            states: {
                                hover: { enabled: false },
                                select: { enabled: false }
                            }
                        }
                    },
                    series: [
                        {
                            name: "Realized Payoff",
                            type: "column",
                            data: [],
                            step: "left",
                        },
                        {
                            name: "Subperiod Average Payoff",
                            type: "line",
                            data: [],
                            step: "left"
                        },
                        {
                            name: "Aa",
                            type: "line",
                            color: 'rgba(0, 100, 0, 0.4)',
                            lineWidth: 10,
                            data: [],
                            step: "left"
                        },
                        {
                            name: "Ab",
                            type: "line",
                            color: 'rgba(0, 100, 0, 0.4)',
                            lineWidth: 10,
                            data: [],
                            step: "left"
                        },
                        {
                            name: "Ba",
                            type: "line",
                            color: 'rgba(255, 100, 0, 0.4)',
                            lineWidth: 10,
                            data: [],
                            step: "left"
                        },
                        {
                            name: "Bb",
                            type: "line",
                            color: 'rgba(255, 100, 0, 0.4)',
                            lineWidth: 10,
                            data: [],
                            step: "left"
                        },
                    ]
                });
                this.realizedPayoffsHistory = this.historyGraph.series[0];
            },
            // updates current payoff value every 100 ms
            _updateCurrSubperiodGraph(realizedPayoff) {
                this.hideProgress = true;
            },
            _updateHistoryGraph(pauseTime) {
                this.hideProgress = false;
            },
            _clearGraph() {
                this.currSubperiodGraph.destroy();
                this._setupCurrSubperiodGraph();
            },
            _buttonActive(myDecision, buttonIndex) {
                return myDecision == buttonIndex ? 'active' : '';
            },
        });
    </script>

</dom-module>