<link
    rel="import"
	href="/static/bower_components/polymer/polymer.html" />
<link
    rel="import"
    href="/static/otree-redwood/webcomponents/redwood-channel/redwood-channel.html">
<link
    rel="import"
    href="/static/otree-redwood/webcomponents/redwood-period/redwood-period.html">
<link
    rel="import"
	href="/static/otree-redwood/webcomponents/redwood-decision/redwood-decision.html">
<link
    rel="import"
    href="bubbles-graph.html">
<link
    rel="import"
    href="payoff-graph.html">
<link
    rel="import"
    href="strategy-graph.html">

<dom-module id='evolving-managers'>
<template>
    <redwood-period
        on-period-start='roundStart'
        >
    </redwood-period>
	<otree-constants id="constants"></otree-constants>
	<redwood-decision
		initial-decision="[[ initialDecision ]]"
		my-decision="{{ myDecision }}"
		group-decisions="{{ groupDecisions }}"
		max-per-second="10">
	</redwood-decision>
    <link rel="stylesheet" href="range.css">

    <style>
        .toprow, .bottomrow {
            border: 1px solid black;
            width: 600px;
        }
        .toprow {
            height: 200px;
        }
        .toprow.left {
            padding: 10px;
        }
        .bottomrow {
            height: 300px;
        }
        #slider-container {
            width: 600px;
            height: 50px;
            position: relative;
        }
        #slider {
            position: absolute;
            width: 95%;
            left: 24px;
            top: 20px;
        }
    </style>
    <table>
        <tr>
            <td>
                <div class="toprow left">
                    <p>
                        Your total accumulated payoffs so far: [[ totalPayoff ]]
                    </p>
                    <p>
                        Your current A: [[ _toFixed(aVar) ]]
                    </p>
                </div>
            </td>
            <td>
                <div class="toprow right">
                    <strategy-graph
                        my-decision='[[ myDecision ]]'
                        other-decisions='[[ otherDecisions ]]'
                        duration='[[ periodLength ]]'>
                    </strategy-graph>
                </div>
            </td>
        </tr>
        <tr>
            <td>
                <div class="bottomrow">
                    <bubbles-graph
                        other-decisions='[[ otherDecisions ]]'
                        max-payoff='[[ maxPayoff ]]'
                        payoff-function='[[ payoffFunction ]]'
                        my-decision='[[ myDecision ]]'
                        others-bubbles='[[ othersBubbles ]]'
                        enable-payoff-landscape
                        max-decision='[[ _calcMaxDecision(aVar) ]]'
                    ></bubbles-graph>
                </div>
            </td>
            <td>
                <div class="bottomrow">
                    <payoff-graph
                        max-payoff='[[ maxPayoff ]]'
                        duration='[[ periodLength ]]'
                        my-payoff='[[ payoff ]]'>
                    </payoff-graph>
                </div>
            </td>
        </tr>
        <tr>
            <td>
                <div id="slider-container">
                    <input
                        id="slider"
                        type="range"
                        min="0"
                        max="[[ _calcMaxDecision(aVar) ]]"
                        step="0.01"
                        on-change="_sliderValueChanged">
                </div>
            </td>
        </tr>
    </table>
    <div>
    </div>
</template>
<script>
    Polymer({
        is: 'evolving-managers',
        properties: {
            initialDecision: {
                type: Number
            },
			otherDecisions: {
				type: Array,
				computed: "_getOtherDecisions(groupDecisions)"
			},
            maxPayoff: {
                type: Number,
                value: 1,
            },
            payoffFunction: {
                type: Object,
                value: function() {
                    return () => 0;
                },
            },
            myDecision: {
                type: Number,
                notify: true,
            },
            periodLength: {
                type: Number,
            },
            // configuration property for how others' bubbles are displayed
            // 3 options
            //     'none': no bubbles are shown for other players
            //     'strategy': just shows everyone's strategy, without showing their payoff
            //     'payoff': shows everyone else's payoffs as well as their strategy
            othersBubbles: {
                type: String,
            },
            payoff: {
                type: Number,
                computed: '_computeMyPayoff(otherDecisions)',
            },
            cVar: {
                type: Number,
            },
            aVar: {
                type: Number,
            },
            totalPayoff: {
                type: Number,
            },
        },
        ready() {
            this.slider = this.$.slider;
            this.bubbles_graph = this.$$('bubbles-graph');
            this.payoff_graph = this.$$('payoff-graph');
            this.strategy_graph = this.$$('strategy-graph');
            this.slider.value = this.myDecision;

            const self = this;
			this.payoffFunction = function(myDecision, otherDecisions) {
				const avg = otherDecisions[0];
				var scalar = self.cVar / Math.pow(self.aVar, 2);

				var payoff = (scalar * (myDecision * (self.aVar - myDecision - avg)));

				return Math.max(payoff, 0);
			};
        },
        roundStart() {
            this.bubbles_graph.roundStart();
            this.payoff_graph.roundStart();
            this.strategy_graph.roundStart();
        },
        _sliderValueChanged(event) {
            this.myDecision = parseFloat(event.target.value);
        },
        _computeMyPayoff(otherDecisions) {
            return this.payoffFunction(this.myDecision, otherDecisions);
        },
		_getOtherDecisions(groupDecisions) {
			let sum = 0;
			let num_players = 0;
            console.log(groupDecisions, this.$.constants.participantCode)
			for (let pcode in groupDecisions) {
                if (pcode != this.$.constants.participantCode) {
                    sum += groupDecisions[pcode];
                    num_players++;
                }
			}
            console.log(sum/num_players)
			return [sum/num_players];
		},
        _calcMaxDecision(aVar) {
            return Math.max(1, aVar/2);
        },
        _toFixed(num) {
            return num.toFixed(2);
        },
    })
</script>
</dom-module>