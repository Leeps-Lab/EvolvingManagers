<link
    rel="import"
	href="/static/bower_components/polymer/polymer.html" />
<link
    rel="import"
    href="/static/otree-redwood/webcomponents/redwood-channel/redwood-channel.html">
<link
    rel="import"
    href="/static/otree-redwood/webcomponents/redwood-period/redwood-period.html">
<link
    rel="import"
	href="/static/otree-redwood/webcomponents/redwood-decision/redwood-decision.html">
<link
    rel="import"
	href="/static/webcomponents/evolving-managers/polymer-bubbles/polymer-bubbles.html">
	
<dom-module id="evolving-managers">
<template>
	<div>
		<redwood-period
			on-period-start='_roundStart'
			>
		</redwood-period>
		<polymer-bubbles
			max-payoff='1'
			other-decisions='[[ otherDecisions ]]'
			my-decision='{{ myDecision }}'
			payoff-function='[[ _payoffFunction ]]'
			duration= '[[ periodLength ]]'
			enable-payoff-landscape
			others-bubbles='payoff'
			>
		</polymer-bubbles>
	</div>

	<otree-constants id="constants"></otree-constants>

	<!-- <div>
		<button on-tap='_randomizeOthers' type="button">Randomize other decisions</button>
		&nbsp;
		<span>my decision: [[ myDecision ]]</span>
	</div> -->

	<redwood-decision
		initial-decision="[[ initialDecision ]]"
		my-decision="{{ myDecision }}"
		group-decisions="{{ groupDecisions }}"
		max-per-second="10">
	</redwood-decision>

</template>

<script>
	Polymer({
		is: 'evolving-managers',
		properties: {
			initialDecision: {
				type: Number,
			},
			myDecision: {
				type: Number
			},
			groupDecisions: {
				type: Object,
			},
			evolveVar: {
				type: Number
			},
			otherDecisions: {
				type: Array,
				computed: "_getOtherDecisions(groupDecisions)"
			},
			periodLength: Number,
			_isPeriodRunning: {
				type: Boolean
			},
			_payoffFunction: {
				type: Object,
				value: function() {
					return () => 0;
				},
			},
			evolve: {
				type: Number,
			},
			c: {
				type: Number,
			},

			////Add vars
		},
		ready() {
			this.myDecision = 0.7/2;

			//var avg = this._getOtherDecisions;

			const evolve = this.evolveVar;
			console.log(evolve);
			const c = this.c;
			console.log(c);

			this._payoffFunction = function(myDecision, otherDecisions) {
				// Payoff function line (change based on A)
				// FIND 1-MY.D-O.D
				// MY.P = MY.D(1-MY.D-O.D)
				const avg = otherDecisions[0];
				var scalar = c / Math.pow(evolve, -2);

				// Payoff with evolved A
				// var payoff = scalar * myDecision * (evolve - myDecision);

				var payoff = (scalar * (myDecision * (evolve - myDecision - avg)));

				// var payoff = myDecision * (1 - myDecision - avg);

				return payoff;
			};
		},
		// _randomizeOthers(groupDecisions) {
		// 	let decisions = [];
		// 	for (let i = 0; i < 1; i++){
		// 		decisions.push(Math.random());
		// 	}
		// 	this.set('groupDecisions', decisions);
		// },
		_getOtherDecisions(groupDecisions) {
			var sum = 0;
			var numberofplayers = 0;
			for (var pcode in groupDecisions) {
				sum += groupDecisions[pcode];
				numberofplayers++;
			}
			return [sum/numberofplayers];
		},
		_roundStart() {
			console.log('started')
			this.$$('polymer-bubbles').roundStart();
		}
	})
</script>

</dom-module>